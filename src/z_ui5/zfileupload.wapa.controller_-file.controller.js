var sValue1;                                                                                                                                                                                                                                                   
sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"sap/m/MessageToast",                                                                                                                                                                                                                                         
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/Sorter"                                                                                                                                                                                                                                         
], function(Controller, MessageToast, Filter, Sorter) {                                                                                                                                                                                                        
	"use strict";                                                                                                                                                                                                                                                 
	return Controller.extend("ZBWFileUpload.controller.File", {                                                                                                                                                                                                   
		onInit: function() {                                                                                                                                                                                                                                         
			//init upload collection                                                                                                                                                                                                                                    
			sValue1 = null;                                                                                                                                                                                                                                             
			var oUploadCollection = this.getView().byId("UploadCollection");                                                                                                                                                                                            
			oUploadCollection.setUploadUrl("/sap/opu/odata/sap/ZFILE_SRV/FileSet");                                                                                                                                                                                     
			//oUploadCollection.setFileType = ["jpg","csv"];                                                                                                                                                                                                            
			var oModel = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZFILE_SRV", false);                                                                                                                                                                      
			this.getView().setModel(oModel);                                                                                                                                                                                                                            
			//sort item by date desc                                                                                                                                                                                                                                    
			var oBindingItems = oUploadCollection.getBinding("items");                                                                                                                                                                                                  
			var aSortersDate = [];                                                                                                                                                                                                                                      
			var bDescending = "desc";                                                                                                                                                                                                                                   
			aSortersDate.push(new Sorter("Sydate", bDescending));                                                                                                                                                                                                       
			aSortersDate.push(new Sorter("Sytime", bDescending));                                                                                                                                                                                                       
			oBindingItems.sort(aSortersDate);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			//init dropbox                                                                                                                                                                                                                                              
			var oFlowID = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/Z_FILEFLOWIDTEXT_CDS", false);                                                                                                                                                          
			this.getView().byId("Flowbox").setModel(oFlowID);                                                                                                                                                                                                           
			var Flowbox = this.getView().byId("Flowbox");                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
			var complete_url = window.location.href;                                                                                                                                                                                                                    
			var pieces = complete_url.split("?");                                                                                                                                                                                                                       
			var n = pieces.length;                                                                                                                                                                                                                                      
			var i;                                                                                                                                                                                                                                                      
			for (i = 0; i < n; i++) {                                                                                                                                                                                                                                   
				if (typeof pieces[i] !== 'undefined') {                                                                                                                                                                                                                    
					var params = pieces[i].split("&");                                                                                                                                                                                                                        
					$.each(params, function(key, value) {                                                                                                                                                                                                                     
						var param_value = value.split("=");                                                                                                                                                                                                                      
						if (param_value[0] === "Flow") {                                                                                                                                                                                                                         
							if (param_value[1] !== "" && param_value[1] !== null) {                                                                                                                                                                                                 
								var aFilters = [];                                                                                                                                                                                                                                     
								var sPath = "Flow";                                                                                                                                                                                                                                    
								var sOperator = sap.ui.model.FilterOperator.Contains;                                                                                                                                                                                                  
								sValue1 = param_value[1];                                                                                                                                                                                                                              
								var oFilter = new Filter(sPath, sOperator, sValue1);                                                                                                                                                                                                   
								aFilters.push(oFilter);                                                                                                                                                                                                                                
								oBindingItems.filter(aFilters);                                                                                                                                                                                                                        
								Flowbox.setVisible(false);                                                                                                                                                                                                                             
								Flowbox.setSelectedKey(sValue1);                                                                                                                                                                                                                       
							}                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
						}                                                                                                                                                                                                                                                        
					});                                                                                                                                                                                                                                                       
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var oDataModelFlowidT = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/Z_FILEFLOWIDTEXT_CDS", false);                                                                                                                                                
			var dataobj = null;                                                                                                                                                                                                                                         
			if (sValue1 !==  null) {                                                                                                                                                                                                                                    
			oDataModelFlowidT.read("/Z_FILEFLOWIDTEXT('" + sValue1 + "')", {                                                                                                                                                                                            
				async: false,                                                                                                                                                                                                                                              
				success: function(oData, response) {                                                                                                                                                                                                                       
					dataobj = oData.FileText;                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
				},                                                                                                                                                                                                                                                         
				error: function(error) {                                                                                                                                                                                                                                   
					var message = "Done";                                                                                                                                                                                                                                     
					sap.m.MessageBox.show(message, sap.m.MessageBox.Icon.ERROR, "Error");                                                                                                                                                                                     
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			var sTitle = "Upload Management";                                                                                                                                                                                                                           
			this.getOwnerComponent().getService("ShellUIService").then(                                                                                                                                                                                                 
				function(oShellUIService) {                                                                                                                                                                                                                                
					if (Flowbox.getSelectedKey() === '') {                                                                                                                                                                                                                    
						oShellUIService.setTitle(sTitle);                                                                                                                                                                                                                        
					} else {                                                                                                                                                                                                                                                  
					                                                                                                                                                                                                                                                          
						oShellUIService.setTitle(dataobj);                                                                                                                                                                                                                       
					}                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				});                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
		onBeforeUploadStarts: function(oEvent) {                                                                                                                                                                                                                     
			var sFlow = this.getView().byId("Flowbox").getSelectedKey();                                                                                                                                                                                                
			var oCustomerHeaderSlug = new sap.m.UploadCollectionParameter({                                                                                                                                                                                             
				name: "slug",                                                                                                                                                                                                                                              
				value: oEvent.getParameter("fileName") + "|" + sFlow                                                                                                                                                                                                       
			});                                                                                                                                                                                                                                                         
			oEvent.getParameters().addHeaderParameter(oCustomerHeaderSlug);                                                                                                                                                                                             
			var oModel = this.getView().getModel();                                                                                                                                                                                                                     
			oModel.refreshSecurityToken();                                                                                                                                                                                                                              
			var oHeaders = oModel.oHeaders;                                                                                                                                                                                                                             
			var sToken = oHeaders["x-csrf-token"];                                                                                                                                                                                                                      
			var oCustomerHeaderToken = new sap.m.UploadCollectionParameter({                                                                                                                                                                                            
				name: "x-csrf-token",                                                                                                                                                                                                                                      
				value: sToken                                                                                                                                                                                                                                              
			});                                                                                                                                                                                                                                                         
			oEvent.getParameters().addHeaderParameter(oCustomerHeaderToken);                                                                                                                                                                                            
		},                                                                                                                                                                                                                                                           
		onUploadComplete: function(oEvent) {                                                                                                                                                                                                                         
			this.getView().getModel().refresh();                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
		/**                                                                                                                                                                                                                                                          
		 *@memberOf ZBWFileUpload.controller.File                                                                                                                                                                                                                    
		 */                                                                                                                                                                                                                                                          
		onDelete: function(oEvent) {                                                                                                                                                                                                                                 
			//This code was generated by the layout editor.                                                                                                                                                                                                             
			//this.deleteItemById(oEvent.getParameter("documentId"));                                                                                                                                                                                                   
			var oModel = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZFILE_SRV", false);                                                                                                                                                                      
			oModel.remove("/FileSet('" + oEvent.getParameter("documentId") + "')");                                                                                                                                                                                     
			MessageToast.show("FileDeleted event triggered.");                                                                                                                                                                                                          
			this.getView().getModel().refresh();                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
		onFileRenamed: function(oEvent) {                                                                                                                                                                                                                            
			//This code was generated by the layout editor.                                                                                                                                                                                                             
			//this.deleteItemById(oEvent.getParameter("documentId"));                                                                                                                                                                                                   
			var oEntry = {};                                                                                                                                                                                                                                            
			oEntry.Id = oEvent.getParameter("documentId");                                                                                                                                                                                                              
			oEntry.FileName = oEvent.getParameter("fileName");                                                                                                                                                                                                          
			var mParameters = {                                                                                                                                                                                                                                         
				success: function() {                                                                                                                                                                                                                                      
					//	console.log("OData Update Success");                                                                                                                                                                                                                   
				},                                                                                                                                                                                                                                                         
				error: function() {                                                                                                                                                                                                                                        
					//	console.log("OData Update Error");                                                                                                                                                                                                                     
				}                                                                                                                                                                                                                                                          
			};                                                                                                                                                                                                                                                          
			var oModel = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZFILE_SRV", true);                                                                                                                                                                       
			oModel.update("/FileSet('" + oEvent.getParameter("documentId") + "')", oEntry, mParameters);                                                                                                                                                                
			MessageToast.show("FileRenamed event triggered.");                                                                                                                                                                                                          
			this.getView().getModel().refresh();                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
		box_changes: function(oEvent) {                                                                                                                                                                                                                              
			//This code was generated by the layout editor.                                                                                                                                                                                                             
			var newval = oEvent.getParameter("newValue");                                                                                                                                                                                                               
			var key = oEvent.getSource().getSelectedItem();                                                                                                                                                                                                             
			if (newval !== "" && key === null) {                                                                                                                                                                                                                        
				oEvent.getSource().setValue("");                                                                                                                                                                                                                           
				oEvent.getSource().setValueState("Error");                                                                                                                                                                                                                 
			} else {                                                                                                                                                                                                                                                    
				oEvent.getSource().setValueState("None");                                                                                                                                                                                                                  
			}                                                                                                                                                                                                                                                           
			var oUploadCollection = this.getView().byId("UploadCollection");                                                                                                                                                                                            
			var oBindingItems = oUploadCollection.getBinding("items");                                                                                                                                                                                                  
			var aFilters = [];                                                                                                                                                                                                                                          
			var sPath = "Flow";                                                                                                                                                                                                                                         
			var sOperator = sap.ui.model.FilterOperator.Contains;                                                                                                                                                                                                       
			sValue1 = this.getView().byId("Flowbox").getSelectedKey();                                                                                                                                                                                                  
			var oFilter = new Filter(sPath, sOperator, sValue1);                                                                                                                                                                                                        
			aFilters.push(oFilter);                                                                                                                                                                                                                                     
			oBindingItems.filter(aFilters);                                                                                                                                                                                                                             
		},                                                                                                                                                                                                                                                           
		onRefresh: function(oEvent) {                                                                                                                                                                                                                                
			this.getView().getModel().refresh();                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
		onElaborate: function(oEvent) {                                                                                                                                                                                                                              
			this.getView().getModel().refresh();                                                                                                                                                                                                                        
			var oUploadCollection = this.getView().byId("UploadCollection");                                                                                                                                                                                            
			var cItems = oUploadCollection.aItems.length;                                                                                                                                                                                                               
			var i;                                                                                                                                                                                                                                                      
			for (i = 0; i < cItems; i++) {                                                                                                                                                                                                                              
				if (oUploadCollection.aItems[i].getSelected() === true) {                                                                                                                                                                                                  
					MessageToast.show(oUploadCollection.aItems[i].mProperties.fileName + " is the attachment Selected"); // oData in modalità GET Custom per reperire da flodid la catena BW                                                                                  
					// oData Std in modalità POST per lanciare catena                                                                                                                                                                                                         
					// /sap/opu/odata/sap/RV_C_PCMPROCESSCHAIN_CDS/Rv_C_PcmProcessChainSchedule?sap-client=100&chainId='ZPCMDM011'                                                                                                                                            
					var choosenvalue = this.getView().byId("Flowbox").getSelectedKey();                                                                                                                                                                                       
					var oDataModelProcess = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZFILE_TEMPLATE_ID_SRV/", true);                                                                                                                                             
					var dataobj = null;                                                                                                                                                                                                                                       
					oDataModelProcess.read("/FileTemplateSet('" + sValue1 + "')", {                                                                                                                                                                                           
						async: false,                                                                                                                                                                                                                                            
						success: function(oData, response) {                                                                                                                                                                                                                     
							dataobj = oData.PPc;                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
						},                                                                                                                                                                                                                                                       
						error: function(error) {                                                                                                                                                                                                                                 
							var message = "Done";                                                                                                                                                                                                                                   
							sap.m.MessageBox.show(message, sap.m.MessageBox.Icon.ERROR, "Error");                                                                                                                                                                                   
						}                                                                                                                                                                                                                                                        
					});                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
					if (dataobj !== 0) {                                                                                                                                                                                                                                      
						var oDataModelProcessChain = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/RV_C_PCMPROCESSCHAIN_CDS/", true);                                                                                                                                    
						this.getView().setModel(oDataModelProcessChain);                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
						oDataModelProcessChain.refreshSecurityToken();                                                                                                                                                                                                           
						var oHeaders = oDataModelProcessChain.oHeaders;                                                                                                                                                                                                          
						var sToken = oHeaders["x-csrf-token"];                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
						oDataModelProcessChain.create("Rv_C_PcmProcessChainSchedule?sap-client=100&chainId='" + dataobj + "'", {                                                                                                                                                 
							//	oDataModelProcess.create("Rv_C_PcmProcessChainSchedule", oParameters,null, {                                                                                                                                                                         
							method: "POST",                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
							async: false,                                                                                                                                                                                                                                           
							success: function(oData, response) {                                                                                                                                                                                                                    
								sap.m.MessageToast.show("Done");                                                                                                                                                                                                                       
							},                                                                                                                                                                                                                                                      
							error: function(error) {                                                                                                                                                                                                                                
								var message = "Error";                                                                                                                                                                                                                                 
								sap.m.MessageBox.show(message, sap.m.MessageBox.Icon.ERROR, "Error");                                                                                                                                                                                  
							}                                                                                                                                                                                                                                                       
						});                                                                                                                                                                                                                                                      
					} else {                                                                                                                                                                                                                                                  
						sap.m.MessageToast.show("Error");                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
					var oModel = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZFILE_SRV", true);                                                                                                                                                                     
					this.getView().setModel(oModel);                                                                                                                                                                                                                          
					var oBindingItems = oUploadCollection.getBinding("items");                                                                                                                                                                                                
					var aFilters = [];                                                                                                                                                                                                                                        
					var sPath = "Flow";                                                                                                                                                                                                                                       
					var sOperator = sap.ui.model.FilterOperator.Contains;                                                                                                                                                                                                     
					sValue1 = this.getView().byId("Flowbox").getSelectedKey();                                                                                                                                                                                                
					var oFilter = new Filter(sPath, sOperator, sValue1);                                                                                                                                                                                                      
					aFilters.push(oFilter);                                                                                                                                                                                                                                   
					oBindingItems.filter(aFilters);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
				}                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
		onTemplate: function(oEvent) {                                                                                                                                                                                                                               
			this.getView().getModel().refresh();                                                                                                                                                                                                                        
			var oUploadCollection = this.getView().byId("UploadCollection");                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
			var choosenvalue = this.getView().byId("Flowbox").getSelectedKey();                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
			var oDataModelTemplate = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/ZFILE_TEMPLATE_ID_SRV/", true);                                                                                                                                              
			var dataobj = null;                                                                                                                                                                                                                                         
			oDataModelTemplate.read("/FileTemplateSet('" + sValue1 + "')", {                                                                                                                                                                                            
				async: false,                                                                                                                                                                                                                                              
				success: function(oData, response) {                                                                                                                                                                                                                       
					dataobj = oData.PId;                                                                                                                                                                                                                                      
					if (dataobj !== 0) {                                                                                                                                                                                                                                      
						var server = window.location.origin;                                                                                                                                                                                                                     
						var link = "/sap/opu/odata/sap/ZFILE_SRV/FileSet('" + dataobj + "')/$value";                                                                                                                                                                             
						window.open(server + link, "_blank");                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
						return true;                                                                                                                                                                                                                                             
						// sap.m.MessageToast.show("Done");                                                                                                                                                                                                                      
					} else {                                                                                                                                                                                                                                                  
						sap.m.MessageToast.show("Error");                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				},                                                                                                                                                                                                                                                         
				error: function(error) {                                                                                                                                                                                                                                   
					var message = "Done";                                                                                                                                                                                                                                     
					sap.m.MessageBox.show(message, sap.m.MessageBox.Icon.ERROR, "Error");                                                                                                                                                                                     
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
		}                                                                                                                                                                                                                                                            
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            